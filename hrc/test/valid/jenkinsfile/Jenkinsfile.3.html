 0: <span class='jenkinsfile-MainMethod def-ClassKeyword def-Keyword'>node</span><span class='jenkinsfile-SymbolStrong def-SymbolStrong def-Symbol'>(</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>COMPONENT_ECS</span><span class='def-StringEdge def-String'>'</span><span class='jenkinsfile-SymbolStrong def-SymbolStrong def-Symbol'>)</span> <span class='jenkinsfile-SymbolStrong def-SymbolStrong def-Symbol'>{</span>
 1:     <span class='def-Keyword'>def</span> MYSQL_DRIVER_LOCATION<span class='def-Symbol'>=</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>http://central.maven.org/maven2/mysql/mysql-connector-java/6.0.6/mysql-connector-java-6.0.6.jar</span><span class='def-StringEdge def-String'>'</span>
 2: 
 3:     <span class='jenkinsfile-MainMethod def-ClassKeyword def-Keyword'>stage</span><span class='def-SymbolStrong def-Symbol'>(</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>Deploy to Dev</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>)</span><span class='def-SymbolStrong def-Symbol'>{</span>
 4:         <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>deleteDir</span><span class='def-SymbolStrong def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>)</span>
 5:         copyArtifacts<span class='def-SymbolStrong def-Symbol'>(</span>projectName<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-String'>testgrid/testgrid</span><span class='def-StringEdge def-String'>'</span><span class='def-Symbol'>,</span> filter<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-String'>distribution/target/*.zip, web/target/*.war, deployment-tinkerer/target/*.war</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>)</span><span class='def-SymbolStrong def-Symbol'>;</span>
 6:         sshagent<span class='def-SymbolStrong def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>[</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>testgrid-dev-key</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>]</span><span class='def-SymbolStrong def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
 7:             <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>sh</span> <span class='def-StringEdge def-String'>"""</span><span class='def-String'></span>
 8: <span class='def-String'>                scp -o StrictHostKeyChecking=no web/target/*.war </span><span class='def-VarStrong def-Var'>${DEV_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${DEV_HOST}</span><span class='def-String'>:/testgrid/deployment/apache-tomcat-8.5.23/webapps/ROOT.war</span>
 9: <span class='def-String'>                scp -o StrictHostKeyChecking=no deployment-tinkerer/target/*.war </span><span class='def-VarStrong def-Var'>${DEV_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${DEV_HOST}</span><span class='def-String'>:/testgrid/deployment/apache-tomcat-8.5.23/webapps/</span>
10: <span class='def-String'>                scp -o StrictHostKeyChecking=no distribution/target/*.zip </span><span class='def-VarStrong def-Var'>${DEV_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${DEV_HOST}</span><span class='def-String'>:/testgrid/testgrid-home/testgrid-dist/WSO2-TestGrid.zip</span>
11: <span class='def-String'>                ssh -o StrictHostKeyChecking=no </span><span class='def-VarStrong def-Var'>${DEV_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${DEV_HOST}</span><span class='def-String'> /bin/bash &lt;&lt; EOF</span>
12: <span class='def-String'>                    cd /testgrid/testgrid-home/testgrid-dist/;</span>
13: <span class='def-String'>                    unzip WSO2-TestGrid.zip -d WSO2-TestGrid-unzipped;</span>
14: <span class='def-String'>                    curl -o ./WSO2-TestGrid-unzipped/lib/mysql.jar </span><span class='def-VarStrong def-Var'>${MYSQL_DRIVER_LOCATION}</span><span class='def-String'></span>
15: <span class='def-String'>                    rm -rf WSO2-TestGrid-backup;</span>
16: <span class='def-String'>                    mv WSO2-TestGrid WSO2-TestGrid-backup;</span>
17: <span class='def-String'>                    mv WSO2-TestGrid-unzipped WSO2-TestGrid;</span>
18: <span class='def-String'>                    ls</span>
19: <span class='def-String'>                </span><span class='def-StringEdge def-String'>"""</span>
20:            <span class='def-SymbolStrong def-Symbol'>}</span>
21:     <span class='def-SymbolStrong def-Symbol'>}</span>
22: 
23:     <span class='jenkinsfile-MainMethod def-ClassKeyword def-Keyword'>stage</span><span class='def-SymbolStrong def-Symbol'>(</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>Deploy to Prod</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>)</span><span class='def-SymbolStrong def-Symbol'>{</span>
24:         <span class='def-Keyword'>def</span> userInput
25:         mail <span class='def-SymbolStrong def-Symbol'>(</span>
26:             to<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>"</span><span class='def-VarStrong def-Var'>${TEAM_MEMBERS}</span><span class='def-String'>,builder@wso2.org</span><span class='def-StringEdge def-String'>"</span><span class='def-Symbol'>,</span>
27:             subject<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>"</span><span class='def-String'>Job '</span><span class='def-VarStrong def-Var'>${env.JOB_NAME}</span><span class='def-String'>' (</span><span class='def-VarStrong def-Var'>${env.BUILD_NUMBER}</span><span class='def-String'>) is waiting for input</span><span class='def-StringEdge def-String'>"</span><span class='def-Symbol'>,</span>
28:             body<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>"</span><span class='def-String'>Hi team,</span><span class='def-Comment def-Syntax'>\n</span><span class='def-String'>Latest artifacts have been deployed to TestGrid-DEV.</span><span class='def-StringEdge def-String'>"</span> <span class='def-Symbol'>+</span>
29:                 <span class='def-StringEdge def-String'>"</span><span class='def-Comment def-Syntax'>\n</span><span class='def-String'>Please do a round of tests and visit </span><span class='def-VarStrong def-Var'>${env.BUILD_URL}</span><span class='def-String'> to approve/decline deploying to TestGrid-PROD.</span><span class='def-StringEdge def-String'>"</span> <span class='def-Symbol'>+</span>
30:                 <span class='def-StringEdge def-String'>"</span><span class='def-Comment def-Syntax'>\n</span><span class='def-String'>You have 1 hour left!</span><span class='def-Comment def-Syntax'>\n</span><span class='def-Comment def-Syntax'>\n</span><span class='def-String'>Thanks!</span><span class='def-StringEdge def-String'>"</span><span class='def-SymbolStrong def-Symbol'>)</span><span class='def-SymbolStrong def-Symbol'>;</span>
31:         <span class='def-Keyword'>try</span> <span class='def-SymbolStrong def-Symbol'>{</span>
32:             <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>timeout</span><span class='def-SymbolStrong def-Symbol'>(</span>time<span class='def-Symbol'>:</span> <span class='def-NumberDec def-Number'>1</span><span class='def-Symbol'>,</span> unit<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-String'>HOURS</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
33:                 userInput <span class='def-Symbol'>=</span> input <span class='def-SymbolStrong def-Symbol'>(</span>
34:                         message<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-String'>Deploy to Prod environment?</span><span class='def-StringEdge def-String'>'</span><span class='def-Symbol'>,</span> parameters<span class='def-Symbol'>:</span> <span class='def-SymbolStrong def-Symbol'>[</span>
35:                         <span class='def-SymbolStrong def-Symbol'>[</span><span class='jenkinsfile-Constant def-Constant def-Keyword'>$class</span><span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-String'>BooleanParameterDefinition</span><span class='def-StringEdge def-String'>'</span><span class='def-Symbol'>,</span> defaultValue<span class='def-Symbol'>:</span> <span class='def-Keyword'>true</span><span class='def-Symbol'>,</span> description<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-StringEdge def-String'>'</span><span class='def-Symbol'>,</span> name<span class='def-Symbol'>:</span> <span class='def-StringEdge def-String'>'</span><span class='def-String'>Please confirm you agree with this.</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>]</span>
36:                 <span class='def-SymbolStrong def-Symbol'>]</span><span class='def-SymbolStrong def-Symbol'>)</span>
37:             <span class='def-SymbolStrong def-Symbol'>}</span>
38:         <span class='def-SymbolStrong def-Symbol'>}</span> <span class='def-Keyword'>catch</span><span class='def-SymbolStrong def-Symbol'>(</span>err<span class='def-SymbolStrong def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='def-LineComment def-Comment def-Syntax'>// input false</span>
39:             userInput <span class='def-Symbol'>=</span> <span class='def-Keyword'>false</span>
40:             <span class='def-Keyword'>def</span> user <span class='def-Symbol'>=</span> err<span class='def-Symbol'>.</span>getCauses<span class='def-SymbolStrong def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>)</span><span class='def-SymbolStrong def-Symbol'>[</span><span class='def-NumberDec def-Number'>0</span><span class='def-SymbolStrong def-Symbol'>]</span><span class='def-Symbol'>.</span>getUser<span class='def-SymbolStrong def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>)</span>
41:             <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>echo</span> $<span class='def-SymbolStrong def-Symbol'>{</span>user<span class='def-Symbol'>.</span><span class='def-FunctionKeyword def-Keyword'>toString</span><span class='def-SymbolStrong def-Symbol'>}</span>
42:             <span class='def-Keyword'>if</span><span class='def-SymbolStrong def-Symbol'>(</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>SYSTEM</span><span class='def-StringEdge def-String'>'</span> <span class='def-Symbol'>=</span><span class='def-Symbol'>=</span> user<span class='def-Symbol'>.</span><span class='def-FunctionKeyword def-Keyword'>toString</span><span class='def-SymbolStrong def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>)</span><span class='def-SymbolStrong def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span> <span class='def-LineComment def-Comment def-Syntax'>// SYSTEM means timeout.</span>
43:                 <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>echo</span> <span class='def-StringEdge def-String'>"</span><span class='def-String'>Aborted due to time-out.</span><span class='def-StringEdge def-String'>"</span>
44:             <span class='def-SymbolStrong def-Symbol'>}</span> <span class='def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
45:                 <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>echo</span> <span class='def-StringEdge def-String'>"</span><span class='def-String'>Aborted by: [</span><span class='def-VarStrong def-Var'>${user}</span><span class='def-String'>]</span><span class='def-StringEdge def-String'>"</span>
46:             <span class='def-SymbolStrong def-Symbol'>}</span>
47:         <span class='def-SymbolStrong def-Symbol'>}</span>
48:         <span class='def-Keyword'>if</span> <span class='def-SymbolStrong def-Symbol'>(</span>userInput <span class='def-Symbol'>=</span><span class='def-Symbol'>=</span> <span class='def-Keyword'>true</span><span class='def-SymbolStrong def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
49:             sshagent<span class='def-SymbolStrong def-Symbol'>(</span><span class='def-SymbolStrong def-Symbol'>[</span><span class='def-StringEdge def-String'>'</span><span class='def-String'>testgrid-prod-key</span><span class='def-StringEdge def-String'>'</span><span class='def-SymbolStrong def-Symbol'>]</span><span class='def-SymbolStrong def-Symbol'>)</span> <span class='def-SymbolStrong def-Symbol'>{</span>
50:                 <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>sh</span> <span class='def-StringEdge def-String'>"""</span><span class='def-String'></span>
51: <span class='def-String'>                    scp -o StrictHostKeyChecking=no web/target/*.war </span><span class='def-VarStrong def-Var'>${PROD_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${PROD_HOST}</span><span class='def-String'>:/testgrid/deployment/apache-tomcat-8.5.24/webapps/ROOT.war</span>
52: <span class='def-String'>                    scp -o StrictHostKeyChecking=no deployment-tinkerer/target/*.war </span><span class='def-VarStrong def-Var'>${PROD_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${PROD_HOST}</span><span class='def-String'>:/testgrid/deployment/apache-tomcat-8.5.24/webapps/</span>
53: <span class='def-String'>                    scp -o StrictHostKeyChecking=no distribution/target/*.zip </span><span class='def-VarStrong def-Var'>${PROD_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${PROD_HOST}</span><span class='def-String'>:/testgrid/testgrid-home/testgrid-dist/WSO2-TestGrid.zip</span>
54: <span class='def-String'>                    ssh -o StrictHostKeyChecking=no </span><span class='def-VarStrong def-Var'>${PROD_USER}</span><span class='def-String'>@</span><span class='def-VarStrong def-Var'>${PROD_HOST}</span><span class='def-String'> /bin/bash &lt;&lt; EOF</span>
55: <span class='def-String'>                        cd /testgrid/testgrid-home/testgrid-dist/;</span>
56: <span class='def-String'>                        unzip WSO2-TestGrid.zip -d WSO2-TestGrid-unzipped;</span>
57: <span class='def-String'>                        curl -o ./WSO2-TestGrid-unzipped/lib/mysql.jar </span><span class='def-VarStrong def-Var'>${MYSQL_DRIVER_LOCATION}</span><span class='def-String'></span>
58: <span class='def-String'>                        rm -rf WSO2-TestGrid-backup;</span>
59: <span class='def-String'>                        mv WSO2-TestGrid WSO2-TestGrid-backup;</span>
60: <span class='def-String'>                        mv WSO2-TestGrid-unzipped WSO2-TestGrid;</span>
61: <span class='def-String'>                        ls</span>
62: <span class='def-String'>                 </span><span class='def-StringEdge def-String'>"""</span>
63:             <span class='def-SymbolStrong def-Symbol'>}</span>
64:         <span class='def-SymbolStrong def-Symbol'>}</span> <span class='def-Keyword'>else</span> <span class='def-SymbolStrong def-Symbol'>{</span>
65:             <span class='jenkinsfile-OtherMethod def-FunctionKeyword def-Keyword'>echo</span> <span class='def-StringEdge def-String'>"</span><span class='def-String'>Not proceeding with prod deployment.</span><span class='def-StringEdge def-String'>"</span>
66:         <span class='def-SymbolStrong def-Symbol'>}</span>
67:     <span class='def-SymbolStrong def-Symbol'>}</span>
68: 
69: <span class='jenkinsfile-SymbolStrong def-SymbolStrong def-Symbol'>}</span>
70: 
